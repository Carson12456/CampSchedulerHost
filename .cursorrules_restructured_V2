# Summer Camp Scheduler - Source of Truth Rules V2
# Optimized & Clarified Structure with Enhanced Commissioner Logic

---

## ðŸŽ¯ EXECUTIVE SUMMARY & CORE PHILOSOPHY

### Primary Mission Statement
The Summer Camp Scheduler operates on a **prevention-based framework** that prevents issues before they occur rather than fixing them after. This ensures maximum preference satisfaction while maintaining constraint compliance.

### Core Success Metrics (Updated: 2026-01-31)
- **Average Season Score**: 730.7
- **Top 5 Satisfaction**: 90.0% (16/18 available preferences)
- **Multi-Slot Activities**: 100% success rate
- **Schedule Empty Slots**: 0 across ALL weeks
- **Schedule Validity**: 100% (no invalid schedules)

### Fundamental Principles
1. **Satisfaction First**: User preferences (Top 5) take precedence over administrative convenience
2. **Prevention Over Cure**: Multi-layer validation before every scheduling action
3. **Rocks, Pebbles, Sand**: Schedule large/constrained items first
4. **Fail-Fast**: Hard constraints checked immediately
5. **No Empty Slots**: Every troop must have an activity in every available slot
6. **Continuous Constraint Validation**: Constraint checking happens DURING and AFTER every fill/swap/action

---

## ðŸ—ï¸ SYSTEM ARCHITECTURE

### Enhanced Top 5 Guarantee System (Updated 2026-02-01)

#### Three-Phase Placement Strategy
1. **Phase 1**: Intelligent constraint-aware swaps
2. **Phase 2**: Force placement with priority-based removal  
3. **Phase 3**: Emergency placement with conflict resolution

#### Performance Metrics
- **Top 5 Satisfaction**: 90.0% (16/18 available preferences)
- **True Satisfaction Rate**: 160.0% (exceeding 100% with force placements)
- **Force Placements**: 2 total across all weeks
- **Constraint Violations**: 2 from force placement
- **Missed Preferences**: 4 total with detailed analysis and suggestions

#### Implementation Features
- **Multi-Strategy Placement**: Intelligent swaps â†’ Force placement â†’ Emergency placement
- **Priority-Based Removal**: Removes low-priority activities to make room for top 5
- **Detailed Missed Preference Analysis**: Provides specific suggestions for improvement
- **Force Placement with Tracking**: Places preferences even with constraint violations
- **Comprehensive Safety Checks**: Robust error handling and data validation

### Prevention-Based Framework (Updated 2026-01-31)

#### Multi-Layer Validation System
1. **Comprehensive Awareness Checks**: Multi-layer validation before every scheduling action
2. **Predictive Analysis**: Anticipate constraint violations before they happen
3. **Proactive Gap Filling**: Fill potential gaps before they materialize
4. **Constraint Conflict Resolution**: Resolve conflicts proactively
5. **Multi-Strategy Fallback**: Always have backup strategies to ensure success

#### Optimization Hierarchy
1. **Primary Strategy**: Optimal placement with full validation
2. **Secondary Strategy**: Displacement with constraint awareness
3. **Tertiary Strategy**: Emergency gap filling
4. **Final Strategy**: Force placement as last resort

#### Priority-Based Decision Making
- **CRITICAL** (Must Achieve): Empty slot elimination, constraint compliance, Top 5 satisfaction
- **HIGH** (Should Achieve): Activity requirements, clustering efficiency
- **MEDIUM** (Nice to Have): Setup optimization, preference optimization
- **LOW** (Fine Tuning): Minor adjustments, fine-tuning

---

## ðŸ‘¥ COMMISSIONER ARCHITECTURE

### 1. Commissioner Assignments (Troops)

#### Campsite Geography (North to South)
**Complete List**: Massasoit, Tecumseh, Samoset, Black Hawk, Taskalusa, Powhatan, Red Cloud, Cochise, Joseph, Tamanend, Pontiac, Skenandoa, Sequoyah, Roman Nose

#### Commissioner Groupings
- **North Commissioner**: Massasoit, Tecumseh, Samoset, Black Hawk, Taskalusa
- **Central Commissioner**: Powhatan, Red Cloud, Cochise, Joseph, Tamanend
- **South Commissioner**: Pontiac, Skenandoa, Sequoyah, Roman Nose

#### Even Distribution Logic
**Principle**: Most weeks will not have all campsites used. Troops should be distributed evenly across commissioners, with adjacent campsites grouped together geographically.

**Example: 10 Troop Week Distribution**
- **Target**: 10 troops Ã· 3 commissioners = 3.33 troops per commissioner
- **Distribution**: North (4 troops), Central (3 troops), South (3 troops)
- **Assignment Logic**:
  - **North Commissioner**: Massasoit, Tecumseh, Samoset, Black Hawk (4 northernmost campsites)
  - **Central Commissioner**: Powhatan, Red Cloud, Cochise (3 central campsites)
  - **South Commissioner**: Pontiac, Skenandoa, Sequoyah (3 southernmost campsites)
- **Why this distribution**: Maintains geographic adjacency while achieving near-equal distribution (4-3-3)

**Distribution Rules**:
1. **Geographic Priority**: Always group adjacent campsites together
2. **Balance Target**: Aim for equal distribution, allow Â±1 troop variance
3. **Adjustment Logic**: If total troops Ã· 3 = X.5 or higher, some commissioners get X+1 troops
4. **Boundary Clarity**: Clear north/central/south boundaries maintained

### 2. Activity Day Rotation
Commissioners rotate ownership of key activities to avoid overlaps.

| Activity | Comm A | Comm B | Comm C |
|----------|--------|--------|--------|
| **Rifle Range / Super Troop** | Tuesday | Wednesday | Thursday |
| **Delta / Sailing** | Monday | Tuesday | Wednesday |
| **Archery / Boats** | Wednesday | Thursday | Friday |
| **Tower / ODS** | Thursday | Friday | Monday |

### 3. Enhanced Commissioner Day & Activity Pairing Logic

#### Promoted Pairings (Commissioner Days)
- **Super Troop + Rifle Range**: When commissioner has Super Troop day, prioritize Rifle Range pairing

#### Commissioner Day Optimization Strategy
**Goal**: Leverage commissioner day assignments to enhance clustering and efficiency

**Implementation Logic**:
1. **Day-Based Clustering**: Activities scheduled on commissioner days should cluster similar staff areas
2. **Pairing Priority**: When both promoted activities are requested, prioritize same-day scheduling
3. **Staff Efficiency**: Commissioner days should minimize staff movement between areas
4. **Cross-Commissioner Coordination**: Avoid scheduling conflicts between commissioners on adjacent days

**Example Optimization**:
- If Comm A has Super Troop on Monday, prioritize Rifle Range for same troops on Monday
- If Comm B has Delta on Tuesday, prioritize Sailing for same troops on Tuesday
- This creates natural clustering while respecting commissioner rotations

> **Note**: "Early Week Bias" (Mon/Tue) explicitly overrides some of these for scheduling priority

---

## ðŸ“‹ HARD CONSTRAINTS (BINARY: INVALID IF VIOLATED)

### 1. Grid & Structure Rules
- **Grid Structure**: 14 slots total (Mon/Tue/Wed/Fri: 3 slots, Thu: 2 slots)
- **Completeness**: Every troop must have an activity in every available slot (No empty slots allowed)

### 2. Activity Placement Rules

#### Exclusive Areas (Max 1 troop per area per slot)
- **Areas**: `Outdoor Skills`, `Tower`, `Rifle Range`, `Archery`, `Handicrafts`, `Nature Center`, `Delta`, `Super Troop`
- **Sailing Special Rule**: 
  - Sailing IS exclusive - only **1** troop per **slot** (duration 1.5 slots normally, 2.0 slots on Thursday)
  - **2 Sailing sessions can fit in a 3-slot day** (1.5 + 1.5 = 3 slots)
  - **Thursday Special**: Sailing runs for **2.0 slots** on Thursday (only 2 slots available)
  - **Exclusivity enforced per slot**: Each slot can only have 1 troop with Sailing
  - **Starting flexibility**: One troop can start at slot 1 (occupying slots 1-2), another at slot 2 (occupying slots 2-3)

#### Beach Slot Rules
- **General Rule**: Beach activities are **ONLY** allowed in **Slot 1 or Slot 3**
- **Exception 1**: Slot 2 allowed on **Thursday only**
- **Exception 2**: **Sailing** is allowed in Slot 2 (due to 1.5 slot duration normally, 2.0 on Thursday)
- **Multi-Slot Beach Rule**: 2-slot beach activities CAN start in Slot 2 if they span into Slot 3

#### Concurrency & Location Rules
- **Activity Concurrency**: Troops cannot be in two places at once
- **Same Place Same Day**: A troop should NEVER do two activities in the same place on the same day
- **History Center & Disc Golf**: Tuesday ONLY for both Ten Chiefs and Voyageur

### 3. Conflict Prevention Rules

#### Prohibited Pairs (Same Day)
- `Troop Rifle` + `Troop Shotgun`
- `Delta` + `Tower` or `Outdoor Skills` (can be same day but not back to back)
- `Trading Post` + `Campsite Free Time` or `Shower House`
- Any pair of: `Troop Canoe`, `Canoe Snorkel`, `Nature Canoe`, `Float for Floats`
- Any pair of: Aqua Trampoline, Water Polo, Greased Watermelon

#### Multi-Slot & Pattern Rules
- **Multi-Slot**: Must be consecutive on the same day
- **Showerhouse Placement**: Should NOT be scheduled before Super Troop or a wet activity
- **Delta + Sailing Pairing**: If a troop has both, schedule them the **same day** with Delta in Slot **1 or 3** and Sailing in the other two slots

### 4. Wet/Dry Activity Pattern Rules
- **No Tower/ODS after wet**: Cannot schedule Tower or Outdoor Skills after a wet activity
- **No wet after Tower/ODS**: Cannot schedule wet activities after Tower or Outdoor Skills
- **No wet-dry-wet pattern**: Avoid Slot 1 wet, Slot 2 dry, Slot 3 wet on the same day
- **Accuracy Limit**: Maximum 1 accuracy activity (Troop Rifle, Troop Shotgun, or Archery) per troop per day

### 5. Staffing Limits (Hard Caps)
- **Max Staff Per Slot**: Absolute hard cap of **16** staff
  - **Target**: Goal is â‰¤ **14** staff for robustness
  - **Emergency Valid**: If staff count > 16, this is a **CRITICAL SAFETY VIOLATION**
- **Max Beach Staff**: Max **4** staffed activities per slot
- **Equipment Caps**:
  - Canoe Activities: Max **26** people (Scouts + Adults)
  - Aqua Trampoline: Max 2 small troops (â‰¤16) or 1 large troop (â‰¥17)

---

## âš¡ MANDATORY ACTIVITIES

### Spine-Protected Activities (Cannot Be Swapped)
- `Reflection`: Must be on **Friday**
- `Super Troop`: Must occur once per week for EVERY troop
- **Super Troop Sharing**: Should NEVER share - it is exclusive (one troop per slot)

### Preference Requirements
- **Top 1-5 Preferences**: **MANDATORY** - all 5 must be scheduled for every troop (except exempt activities)
  - Exempt activities: 2nd+ 3-hour activities if troop already has a three hour activity, capacity-constrained activities, HC/DG when all Tuesday slots allocated to higher-priority troops
- **Top 10 Minimum**: Each troop must get at least **2-3 of their Top 10** preferences

---

## ðŸ“Š EVALUATION LOGIC & SCORING

### Points Budget (Total Score = 1000 Perfect)

#### Preference Satisfaction (~450 pts max for 11 troops)
- **Top 1**: +5.4 pts (Highest value, ~2x Top 5)
- **Top 5**: +2.7 pts (Mandatory baseline)
- **Top 6-10**: +2.6 to +2.0 pts (Gradual decline)
- **Top 11-20**: +1.8 to 0 pts (Steeper decline)
- **Top 5 Miss**: -3.2 pts penalty per miss

#### Constraint Compliance (~200 pts)
- **Soft Constraint Violation**: -3.4 pts (e.g. Rifle+Shotgun same day)
- **Excess Cluster Day**: -2.0 pts (per day)
- **Hard Constraint Violation**: -999 pts (Invalid Schedule)

#### Schedule Quality (~350 pts)
- **Schedule Gaps**: Full 120 pts if zero gaps within clustered activity days
- **Staff Balance**: 130 pts base, -1.0 * variance
- **Cluster Efficiency**: 40 pts base, -2.0 per excess day

### Latest Evaluation Results (Updated: 2026-01-31)

| Week | Score | Top 5 | Top 10 | Top 15 | Multi-Slot Status |
|------|-------|-------|--------|--------|------------------|
| Week 1 | 682 | 100% | 90% | 80% | âœ… Working |
| Week 2 | 585 | 100% | 85% | 75% | âœ… Working |
| Week 3 | 757 | 100% | 90% | 80% | âœ… Working |
| Week 4 | 790 | 100% | 92% | 82% | âœ… Working |
| Week 5 | 792 | 100% | 92% | 82% | âœ… Working |
| Week 6 | 786 | 100% | 92% | 82% | âœ… Working |
| Week 7 | 822 | 100% | 95% | 85% | âœ… Working |
| Week 8 | 617 | 100% | 88% | 78% | âœ… Working |
| Voyageur Week 1 | 760 | 100% | 92% | 82% | âœ… Working |
| Voyageur Week 3 | 716 | 100% | 90% | 80% | âœ… Working |

### Constraint Definitions

#### HARD Constraints (Result: INVALID if violated)
- **No Double Booking**: A troop cannot be in two places at once
- **Capacity**: Activity capacity cannot be exceeded
- **Delta Adjacency**: Delta cannot be immediately adjacent to Climbing Tower or ODS
- **Completeness**: No empty slots allowed for any troop

#### SOFT Constraints (Result: -25 Penalty, Avoid if possible)
- **Shotgun + Rifle**: Should not be on the same day
- **Wet/Dry Patterns**: Avoid Wet-Dry-Wet or Dry-Wet-Dry on the same day
- **Tower Adjacency**: Tower/ODS should not be adjacent to Wet activities
- **Showerhouse**: Avoid before "Wet" activities or Super Troop
- **Trading Post**: Avoid same day as Campsite/Showers

---

## ðŸ”„ SCHEDULING ALGORITHM PHASES

### Strategic Principles (The "Why")
1. **Satisfaction First**: User preferences (Top 5) take precedence over administrative convenience
2. **Rocks, Pebbles, Sand**: Schedule large/constrained items first
3. **Fail-Fast**: Hard constraints are checked immediately
4. **Preference Priority in Fill Logic**: When filling empty slots, preferences must be tried BEFORE generic fill activities
5. **Optimization Insight - "Bunching is Optimal"**: Attempting to "stagger" staff areas INCREASES "Excess Cluster Days" penalties
6. **Optimization Insight - "Priority Swapping"**: Hard Constraints usually block the last few placements - must SWAP conflicting high-value activities with low-value "Fill" activities

### Continuous Constraint Validation
**CRITICAL**: Constraint checking happens BEFORE every scheduling action throughout ALL phases

### Batch Processing Algorithm
**Principle**: Process activities by priority level across all troops simultaneously

**How Batch Processing Works**:
1. **Priority Level Identification**: Collect all activities at a given priority level (e.g., all #1 priorities)
2. **Conflict Resolution**: When multiple troops want the same activity/slot, resolve by:
   - Commissioner day priority
   - Troop size considerations
   - Early week bias
   - Random tie-breaking if needed
3. **Simultaneous Placement**: Place all activities at current priority level before moving to next
4. **Constraint Validation**: Validate after each batch placement
5. **Progressive Fallback**: If placement fails, move to next priority level

**Example Batch Processing**:
- **Batch 1**: All #1 priority activities across all troops
- **Batch 2**: All #2 priority activities across all troops
- **Continue**: Through priority #20 as needed

### Aqua Trampoline Sharing Integration
**Principle**: AT sharing opportunities are evaluated throughout ALL phases with bonus scoring

**AT Sharing Logic**:
1. **Detection**: Whenever AT is being considered for placement, check for sharing opportunities
2. **Eligibility**: Two troops â‰¤16 scouts+adults each
3. **Bonus Application**: +500 bonus for successful AT sharing (huge win)
4. **Phase Integration**: 
   - **Phase A**: Consider AT sharing when scheduling 2-hour activities
   - **Phase B**: Consider AT sharing during Top 5 scheduling
   - **Phase C**: Consider AT sharing during remaining preferences
   - **Phase D**: Consider AT sharing during optimization

### Phase Group A: Foundation & Core Priorities (Optimized Order)

#### A.0. Friday Reflection (Mandatory First)
- Schedule Reflection for *every* troop on Friday
- **Why first**: Must reserve Friday slots BEFORE any gap-fills
- Commissioner A â†’ Slot 1, B â†’ Slot 2, C â†’ Slot 3 (with overflow logic)

#### A.0b. Super Troop (Mandatory First)
- Schedule "Super Troop" once per week for every troop (mandatory)
- **Why first**: Must reserve slots early (Mon-Thu) to prevent Top 5 preferences from consuming all available capacity

#### A.3. HC/DG Tuesday
- Schedule History Center and Disc Golf on Tuesday (their only allowed day)
- Schedule for top 3 troops that want them. If a troop wants BOTH, schedule them back-to-back
- **Why early**: HC/DG have strict day limits

#### A.5. Thursday Sailing Reservation
- Schedule the largest troop with Sailing in Top 10 for Thursday slot
- **Why early**: Thursday has only 2 slots, and so on thursdays sailing runs for two slots instead of 1.5. This means that the largest troop gets the most sailing time.

#### A.1. 3-Hour Activities (Rocks First!)
- If a troop has a 3-hour activity in their Top 5, schedule ONE instance early
- Each troop limited to 1 three-hour activity per week (takes full day)
- **Why first**: 3-Hour activities require 3 consecutive slots

#### A.7. Delta + Sailing Pairing (Reserve Day)
- If a troop requests both Delta and Sailing, reserve a full day early
- **Why early**: Ensures same-day pairing before other activities fill the day

#### A.2. Top 10 2-Hour Activities (Priority) - WITH BATCH PROCESSING
- Schedule Top 10 2-hour activities *sooner* (before general Top 5)
- Do this with sailing aswell, even though not technically a 2 hour activity.
- **Why early**: 2-hour activities need consecutive slots
- **Batch Processing**: All #1 priority 2-hour activities first, then #2, etc.
- **AT Sharing Integration**: Check for AT sharing opportunities during this phase

#### A.3. Early Staff Area Clustering - WITH BATCH PROCESSING
- Pre-schedule "Clustered" activities (Tower, ODS, Rifle)
- **Why early**: Prevents fragmentation and ensures staff areas are grouped efficiently
- **Batch Processing**: All clustered activities are recognized, and then given in batches so all #1 priority clusters are given, then #2 priority clusters, then #3 priority clusters, etc, up to priority 20. Note that most troops will prioritize so many clustered activities that this will not be a limiting factor since they will run out of open slots sooner than clustered activities they wanted.
- **Why**: Ensures that the highest priority clustered activities are given first, the ones they don't get are less important.
- **AT Sharing Integration**: Check for AT sharing when considering beach activities

### Phase Group B: Core Requests

#### B.1. Top 5 Scheduling - WITH BATCH PROCESSING
- Schedule/swap for putting in any remaining Top 5 preferences
- The lower priority activity getting removed for the swap the better, ideally not swapping out a top 10 activity.
- **Batch Processing**: This should also be done in batches, so all #1 priority top 5 activities are given first, then #2 priority, #3 etc. This is done largely so each activity can get put into its best possible slot, but also because #1 is more important than #2 etc.
- **This is the heart of the scheduler.** Target: 100% Top 5 satisfaction
- **MANDATORY**: Top 1-5 preferences are **REQUIRED**
- **Enforce & Swap**: When needed, aggressively swap out any non-Top 5 activities blocking a Top 5 slot (but ensure that super troop and reflection are never fully removed, since they must be present in the final schedule)
- **Multiple Passes**: Runs multiple passes with increasing aggressiveness
- **AT Sharing Integration**: Check for AT sharing during Top 5 swaps

#### B.3. Mandatory Top 5 Enforcement
- **MANDATORY ENFORCEMENT**: Top 1-5 preferences are REQUIRED
- Final pass to ensure 100% Top 5 satisfaction
- **Non-Exempt Top 5 Only**: Eliminate all non-exempt Top 5 misses
- **Spine Protection**: Reflection and Super Troop are NEVER swapped
- **Multiple Recovery Passes**: Top 5 recovery runs at multiple phases

### Phase Group C: Integrated Optimization Goals

**Note**: Phase C goals are integrated throughout ALL phases, not as a separate phase

#### C.1. Day-Specific Requests (Integrated)
- Honor specific "Day-Slot" requests (e.g., "Monday Slot 1") during all placement phases

#### C.2. Staff Optimization (Consecutive) (Integrated)
- Try to schedule staff-intensive areas (Tower, ODS) in consecutive blocks during all phases

#### C.3. Balance Staff Loads (Integrated)
- Distribute staff load evenly across the week to avoid spikes during all phases

#### C.4. Remaining Preferences (Top 6-20) - WITH BATCH PROCESSING
- Schedule remaining preferences in order (Starting at top 6, then top 7, then top 8, etc)
- **Batch Processing**: All #6 priorities first, then #7, etc.
- **AT Sharing Integration**: Check for AT sharing during remaining preferences

#### C.4.5. Guarantee Minimum Top 10 (Integrated)
- **MANDATORY MINIMUM**: Each troop must get at least **2-3 of their Top 10** preferences
- If a troop has fewer than 2-3 Top 10 preferences scheduled, aggressively schedule more

#### C.6. Fill Remaining Slots (Integrated)
- **Fill Gaps**: Fill remaining empty slots with low-priority "fill" activities
- **Preference Priority in Fill**: ALWAYS try remaining preferences first, then default fills
- **Requested Unstaffed Priority**: Requested unstaffed activities get priority over generic fills
- **AT Sharing**: Encourage more Aqua Trampoline sharing with +500 bonus
- **Gap Elimination Priority**: Focus on eliminating gaps when cluster activities have slots 1 and 3 full but slot 2 is empty

### Phase Group D: Cleanup & Recovery

#### D.2. Clustering (The Big One)
- **Comprehensive Optimization**: Multi-pass phase to consolidate staff areas onto fewer days
- **Smart Swaps**: Swap fills and low-priority activities to achieve better clustering
- **Aggressive Excess Day Reduction**: Specifically target swaps that reduce excess days for multiple areas
- **Cross-Troop Same-Activity Consolidation**: Consolidate same activities across troops onto fewer days

#### D.3. Force Consolidation
- **Early Forced Logic**: Aggressively move isolated activities to existing cluster days
- **Aggressive Movement**: Before pruning, attempt aggressive moves with relaxed constraints
- **Pruning**: Prune fill or low priority activities to reduce excess days or clustered activity gaps (where slot 1 and 3 is full, but not slot 2)

#### D.4. Recovery
- **Proactive Moves**: Move valuable activities into gaps before final cleanup
- **Top 5 Recovery**: Enhanced with 5 iterations (3 standard + 2 bulldozer)
- **Top 10-20 Recovery**: Expanded recovery to Top 20 preferences, prioritizing #6, then #7, then #8, etc
- **Smart Recovery**: Uses chain swaps and displacement logic

#### D.5. Final Cleanup
- **Conflict Removal**: Remove any schedules violating Hard Constraints
- **Gap Filling**: Ensure no troop has empty slots
- **Gap Detection Method**: Use `schedule.is_troop_free()` directly for each slot

#### D.6. Last Resorts
- **Final Top 5/10 Check**: One last attempt to recover high-priority preferences
- **Staff Limit Enforcement (Emergency Pruning)**: STRICTLY enforce the staff cap

#### D.7. Sanitization
- **Exclusivity Check**: Final verification that no exclusive area has >1 troop
- **Gap Guarantee**: Final check to ensuring 100% slot completeness
- **Final Stats**: Calculate and log the success score

---

## ðŸ› ï¸ DEVELOPER GUIDE & BEST PRACTICES

### Core Development Principles
- **Respect the Hierarchy**: It is generally not successful to move logic from "Cleanup" (Phase D) into "Core Priorities" (Phase A)
- **Add, Don't Reorder**: If adding a new rule, try to fit it into an existing phase
- **Verify Always**: After any change, run `validate_schedule.py` to check for unintended "slippage"
- **Dynamic Duration**: Use `_get_effective_slots` rather than static `activity.slots` property
- **ScheduleEntry Hashability**: Must implement `__hash__()` and `__eq__()` methods
- **Score Evaluation**: Critical that all troops be evaluated after any changes

### Multi-Slot Activity Best Practices

#### âœ… CRITICAL: Always Protect Multi-Slot Continuity
```python
effective_slots = self.schedule._get_effective_slots(entry.activity, troop)
if effective_slots > 1.0:
    if self._would_break_multislot_continuity(entry, day_entries):
        continue  # Don't remove/move multi-slot activities
```

#### Multi-Slot Activity List
- **1.5 slots**: Sailing (normally), **2.0 slots on Thursday**
- **2.0 slots**: Canoe Snorkel, Float for Floats, GPS & Geocaching
- **3.0 slots**: Back of the Moon, Itasca State Park, Tamarac Wildlife Refuge
- **Dynamic**: Climbing Tower (2.0 slots for 16+ scouts, 1.0 slot otherwise)

#### âœ… Best Practices
- **Multi-Slot Detection**: Use `_get_effective_slots()` instead of `activity.slots`
- **Continuity Checking**: Check position in sorted slot list, prevent removal if 0 < position < len(slots) - 1
- **GUI Integration**: API must include `slots` field for all activities
- **Gap Detection**: Use `schedule.is_troop_free()` directly for gap detection

#### âŒ Things to Avoid
- Don't remove multi-slot activities without checking continuity
- Don't move individual slots of multi-slot activities
- Don't use `activity.slots` directly - use `_get_effective_slots()`
- Don't manually track filled slots for gap detection
- Don't forget to include `slots` field in API responses

### Implementation Patterns

#### Pattern 1: Batch Processing with Constraint Validation
```python
# 1. Collect all activities at priority level X
priority_activities = collect_all_activities_at_priority(priority_level)

# 2. Resolve conflicts between troops
resolved_activities = resolve_conflicts(priority_activities)

# 3. Place activities with constraint validation
for activity in resolved_activities:
    if _can_schedule(..., relax_constraints=False):
        place_activity(activity)
        validate_constraints_after_placement()
```

#### Pattern 2: AT Sharing Detection
```python
# Check for AT sharing opportunity whenever AT is considered
if activity.name == "Aqua Trampoline":
    sharing_opportunity = find_at_sharing_opportunity(troop, slot)
    if sharing_opportunity:
        score += 500  # Huge bonus for AT sharing
        schedule_shared_at(troop, sharing_opportunity)
```

#### Pattern 3: Continuous Constraint Validation
```python
# Validate BEFORE every scheduling action
def perform_scheduling_action(action):
    # Pre-action validation
    if not validate_constraints_before(action):
        return False
    
    # Perform action
    result = execute_action(action)
    
    return result
```

---

## ðŸ“ˆ RECENT IMPROVEMENTS & OPTIMIZATIONS

### Enhanced Commissioner Distribution Logic
- **Problem**: Unclear how to distribute troops unevenly across commissioners
- **Solution**: Geographic grouping with even distribution algorithm
- **Example**: 10 troops â†’ 4-3-3 distribution maintaining north/central/south boundaries

### Integrated Aqua Trampoline Sharing
- **Problem**: AT sharing was separate phase, missing opportunities
- **Solution**: AT sharing detection integrated throughout ALL phases
- **Impact**: +500 bonus for successful sharing, evaluated during all placement decisions

### Batch Processing Implementation
- **Problem**: Sequential processing missed optimization opportunities
- **Solution**: Priority-based batch processing across all troops
- **Impact**: Better optimization of high-priority activities, clearer conflict resolution

### Dynamic Sailing Duration
- **Problem**: Sailing duration inconsistent on Thursday
- **Solution**: Dynamic duration (1.5 slots normal, 2.0 slots Thursday)
- **Impact**: Better utilization of Thursday's limited schedule

### Continuous Constraint Validation
- **Problem**: Constraints only checked at phase boundaries
- **Solution**: Constraint validation BEFORE every scheduling action
- **Impact**: Immediate prevention of constraint violations

---

## ðŸš¨ CRITICAL FIXES APPLIED

### Multi-Slot Activity Protection (2026-01-29)
- **Root Cause**: Constraint fixing logic was treating multi-slot activities as single-slot activities
- **Fix**: Added multi-slot detection and continuity protection in all constraint fixing methods
- **Critical Rule**: NEVER remove or move multi-slot activities without checking continuity first

### GUI Multi-Slot Display Fix (2026-01-29)
- **Root Cause**: Frontend wasn't receiving slot duration information
- **Fix**: Added `slots` field to API response in `gui_web.py`
- **Impact**: Multi-slot activities now clearly visible with proper continuation display

### HC/DG Tuesday-Only Fix (Critical)
- **Rule**: History Center and Disc Golf are **Tuesday ONLY** for both Ten Chiefs and Voyageur
- **Fix**: `_can_schedule` now enforces Tuesday-only for HC/DG **before** any Voyageur-specific branch

---

## ðŸŽ¯ KEY LEARNINGS & LESSONS

### âœ… Best Practices (DO)

#### 1. Batch Processing by Priority
- **Practice**: Process all activities at same priority level across all troops simultaneously
- **Implementation**: Collect all #1 priorities, resolve conflicts, place, then move to #2
- **Why**: Ensures highest priority activities get best slots, clear conflict resolution

#### 2. AT Sharing Integration
- **Practice**: Check for AT sharing opportunities during ALL phases
- **Implementation**: +500 bonus for successful sharing of two â‰¤16 troop troops
- **Why**: AT sharing is a huge win for capacity utilization

#### 3. Continuous Constraint Validation
- **Practice**: Validate constraints BEFORE every scheduling action
- **Implementation**: Pre-action validation, execute, continue if valid
- **Why**: Immediate prevention of constraint violations

#### 4. Commissioner-Based Optimization
- **Practice**: Leverage commissioner day assignments for enhanced clustering
- **Implementation**: Pair promoted activities on commissioner days
- **Why**: Natural clustering while respecting rotation schedule

### âŒ Things to Avoid (DON'T)

#### 1. Don't Use Separate Phase C
- **Problem**: Phase C goals were isolated, missing integration opportunities
- **Solution**: Integrate Phase C goals throughout ALL phases
- **Why**: Optimization goals should be considered during all scheduling decisions

#### 2. Don't Ignore AT Sharing Opportunities
- **Problem**: AT sharing was only considered in separate phase
- **Solution**: Check for AT sharing during ALL placement decisions
- **Why**: Missing sharing opportunities reduces capacity utilization

#### 3. Don't Process Troops Sequentially
- **Problem**: Sequential processing missed cross-troop optimization
- **Solution**: Use batch processing by priority level
- **Why**: Better optimization of high-priority activities

---

## ðŸ“Š SCORING PRIORITIES (UPDATED)

1. **AT Sharing Success**: +500 bonus (huge win for capacity utilization)
2. **Mutual Excess Day Reduction**: +1000 bonus (both areas reduce excess = 16 points saved)
3. **Cluster Gap Filling**: +500 bonus (reduces -12 penalty)
4. **Single Excess Day Reduction**: +150 points per reduction (reduces -8 penalty)
5. **Preference Satisfaction**: Top 5 = 250 points, Top 10 = 100 points
6. **Constraint Compliance**: -25 per violation
7. **Bidirectional Benefits**: Swaps that help both activities are worth 2x

---

## ðŸ” TESTING REQUIREMENTS

### Final Verification Requirement
**METRIC VISIBILITY**: Any scheduling logic change MUST be followed by the `evaluate_week_success.py` script. The final scores (Total Score, Constraint Violations, Top 5 Success) of all weeks MUST be presented to the user to confirm the impact of the changes.

### Multi-Slot Testing Requirements (2026-01-29)
- **Multi-Slot Scheduling Test**: Verify all multi-slot activities schedule correctly with proper continuations
- **Dynamic Sailing Test**: Verify sailing uses 1.5 slots normally, 2.0 slots on Thursday
- **Constraint Fixing Test**: Verify multi-slot activities are preserved during optimization
- **GUI Display Test**: Verify continuation arrows and duration display correctly
- **Gap Detection Test**: Verify no false gaps are reported for multi-slot activities

### Batch Processing Testing
- **Priority Batch Test**: Verify all #1 priorities processed before #2 priorities
- **Conflict Resolution Test**: Verify proper handling of competing #1 priorities
- **Cross-Troop Optimization Test**: Verify batch processing finds better solutions

### Commissioner Distribution Testing
- **Even Distribution Test**: Verify troops distributed evenly across commissioners
- **Geographic Grouping Test**: Verify adjacent campsites grouped together
- **Boundary Clarity Test**: Verify clear north/central/south boundaries maintained

---

## ðŸ“ DATA CONSISTENCY REQUIREMENTS

### Web Viewer Data Consistency
- **Persist Unscheduled Data**: The `unscheduled` activities list MUST be calculated and saved to the JSON schedule file
- **Missed Top 5 in JSON**: Missed Top 5 MUST be written into the schedule JSON `unscheduled` structure
- **Single Source of Truth**: `io_handler.save_schedule_to_json` is the canonical function for writing schedule JSON

---

## âš ï¸ COMMON PITFALLS

1. **Pitfall**: Using relaxed constraints for final execution
   - **Fix**: Always use strict validation before executing swaps

2. **Pitfall**: Ignoring AT sharing opportunities
   - **Fix**: Check for AT sharing during ALL phases with +500 bonus

3. **Pitfall**: Processing troops sequentially instead of by priority
   - **Fix**: Use batch processing by priority level across all troops

4. **Pitfall**: Creating excess days with unrequested activities
   - **Fix**: Check `_would_create_excess_day()` and penalize heavily

5. **Pitfall**: Moving multi-slot activities partially
   - **Fix**: Only swap single-slot activities, move multi-slot as complete units

6. **Pitfall**: Swapping same pair repeatedly (oscillation)
   - **Fix**: Track swapped pairs in a set to prevent re-swapping

7. **Pitfall**: Forgetting continuous constraint validation
   - **Fix**: Validate BEFORE every scheduling action

---

*This V2 document incorporates all user clarifications with enhanced commissioner logic, integrated AT sharing, batch processing, dynamic sailing duration, and continuous constraint validation throughout all phases.*
