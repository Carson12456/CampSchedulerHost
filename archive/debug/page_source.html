<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer Camp Scheduler - Ten Chiefs 2024</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #4a9eff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #888;
            font-size: 1.2em;
        }

        .tab-section {
            margin-bottom: 20px;
        }

        .tab-section h3 {
            color: #4a9eff;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 20px;
            background: #2d2d30;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .tab-button:hover {
            background: #3d3d40;
        }

        .tab-button.active {
            background: #4a9eff;
        }

        .schedule-container {
            background: #2d2d30;
            border-radius: 10px;
            padding: 12px;
            overflow-x: auto;
        }

        .schedule-title {
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #4a9eff;
            text-align: center;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            gap: 1px;
            min-width: 480px;
            font-size: 0.6em;
        }

        .grid-header {
            background: #3d3d40;
            padding: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 10px;
        }

        .grid-cell {
            background: #2d2d30;
            padding: 6px;
            text-align: center;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            font-size: 8px;
        }

        .grid-cell.activity {
            background: #2d5016;
            color: #fff;
            font-weight: 500;
        }

        .grid-cell.activity.priority-high {
            background: #2d5016;
            /* Vibrant green for Top 5 */
        }

        .grid-cell.activity.priority-medium {
            background: #2a3a16;
            /* Darker green for Top 6-10 */
        }

        .grid-cell.activity.priority-moderate {
            background: #5c5016;
            /* Bright yellow for Top 11-15 */
        }

        .grid-cell.activity.priority-moderate-low {
            background: #4d4016;
            /* Darker yellow for Top 16-20 */
        }

        .grid-cell.activity.priority-commissioner {
            background: #1a3a5a;
            /* Blue for commissioner activities */
        }

        .grid-cell.activity.priority-low {
            background: #3a3a3a;
            /* Gray for 20+ */
        }

        .grid-cell.continuation {
            background: #1d3d0d;
            font-style: italic;
        }

        .activity-name {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 8px;
        }

        .activity-duration {
            font-size: 7px;
            color: #aaa;
        }

        .continuation-arrow {
            font-size: 10px;
            margin-right: 2px;
        }

        .slot-label {
            background: #3d3d40;
            padding: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 9px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #888;
        }

        .week-selector {
            margin-top: 15px;
        }

        .week-selector select {
            padding: 8px 16px;
            font-size: 16px;
            background: #2d2d30;
            color: #fff;
            border: 2px solid #4a9eff;
            border-radius: 5px;
            cursor: pointer;
        }

        .week-selector select:hover {
            background: #3d3d40;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>⛺ Summer Camp Scheduler</h1>
        <p>Ten Chiefs - 2024</p>
        <div class="week-selector">
            <select id="weekSelect" onchange="changeWeek(this.value)">
                
                <option value="sample_troops" >
                    
                </option>
                
                <option value="tc_week1_troops" >
                    
                </option>
                
                <option value="tc_week5_troops" >
                    
                </option>
                
                <option value="tc_week6_troops" >
                    
                </option>
                
                <option value="tc_week7_troops" >
                    
                </option>
                
                <option value="test_split_troops" >
                    
                </option>
                
                <option value="voyageur_week3_troops" selected>
                    
                </option>
                
            </select>
        </div>
        <p style="font-size: 14px; margin-top: 5px;">Week Total: <span id="weekTotal"></span></p>
    </div>

    <div class="tab-section">
        <h3>👥 Troops</h3>
        <div class="tabs" id="troopTabs"></div>
    </div>

    <div class="tab-section">
        <h3>🏕️ Areas</h3>
        <div class="tabs" id="areaTabs"></div>
    </div>

    <div class="tab-section">
        <h3>🎯 Staff Schedules</h3>
        <div class="tabs" id="staffTabs"></div>
    </div>

    <div class="schedule-container">
        <div class="schedule-title" id="scheduleTitle">Select a view</div>
        <div id="scheduleContent" class="loading">Loading...</div>
    </div>

    <script>
        const troops = [{"adults": 4, "campsite": "Quetico", "commissioner": "Voyageur A", "day_requests": {}, "name": "Quetico", "preferences": ["Aqua Trampoline", "9 Square", "Greased Watermelon", "Sauna", "Water Polo", "Climbing Tower", "Troop Shotgun", "Reserve Shower House", "Archery/Tomahawks/Slingshots", "Monkey\u0027s Fist", "Canoe Snorkel", "Float for Floats", "Itasca State Park", "Back of the Moon"], "scouts": 20}, {"adults": 4, "campsite": "Two Harbors", "commissioner": "Voyageur A", "day_requests": {}, "name": "Two Harbors", "preferences": ["Delta", "Greased Watermelon", "Aqua Trampoline", "Canoe Snorkel", "Gaga Ball", "Water Polo", "Troop Rifle", "9 Square", "Chopped!", "Float for Floats", "Archery/Tomahawks/Slingshots", "Troop Shotgun", "Sailing", "Climbing Tower", "Sauna", "Fishing"], "scouts": 9}, {"adults": 12, "campsite": "Hibbing 1", "commissioner": "Voyageur B", "day_requests": {}, "name": "Hibbing 1", "preferences": ["Greased Watermelon", "Sailing", "Aqua Trampoline", "Climbing Tower", "Troop Shotgun", "Chopped!", "Campsite Time/Free Time", "Reserve Shower House", "Float for Floats", "Water Polo", "9 Square", "What\u0027s Cooking", "Troop Rifle", "Canoe Snorkel", "Gaga Ball"], "scouts": 22}, {"adults": 3, "campsite": "Hibbing 2", "commissioner": "Voyageur B", "day_requests": {}, "name": "Hibbing 2", "preferences": ["Aqua Trampoline", "Climbing Tower", "Chopped!", "Sailing", "Tie Dye", "Canoe Snorkel", "Archery/Tomahawks/Slingshots", "Float for Floats", "Reserve Shower House", "Hemp Craft", "Back of the Moon", "Water Polo", "9 Square", "Ultimate Survivor", "Itasca State Park"], "scouts": 10}, {"adults": 4, "campsite": "Ft. Francis", "commissioner": "Voyageur C", "day_requests": {}, "name": "Ft. Francis", "preferences": ["Aqua Trampoline", "Greased Watermelon", "9 Square", "Water Polo", "Gaga Ball", "Float for Floats", "Campsite Time/Free Time", "Archery/Tomahawks/Slingshots", "Climbing Tower", "Reserve Shower House", "Reserve Trading Post", "Sailing", "Troop Canoe", "Canoe Snorkel", "Snorkeling", "Water Polo", "9 Square", "Disc Golf", "History Center", "What\u0027s Cooking"], "scouts": 24}, {"adults": 2, "campsite": "Ft. William", "commissioner": "Voyageur C", "day_requests": {}, "name": "Ft. William", "preferences": ["Greased Watermelon", "Aqua Trampoline", "Water Polo", "Troop Canoe", "Gaga Ball", "History Center", "9 Square", "Archery/Tomahawks/Slingshots", "Canoe Snorkel", "Campsite Time/Free Time", "9 Square"], "scouts": 16}, {"adults": 14, "campsite": "Fond Du Lac", "commissioner": "Voyageur A", "day_requests": {}, "name": "Fond Du Lac", "preferences": ["Aqua Trampoline", "Troop Rifle", "Climbing Tower", "Delta", "Greased Watermelon", "Archery/Tomahawks/Slingshots", "Sailing", "Water Polo", "Troop Shotgun", "9 Square", "Campsite Time/Free Time", "Knots and Lashings", "Gaga Ball", "Orienteering", "Itasca State Park", "Back of the Moon"], "scouts": 17}, {"adults": 5, "campsite": "Duluth", "commissioner": "Voyageur B", "day_requests": {}, "name": "Duluth", "preferences": ["Aqua Trampoline", "Climbing Tower", "Water Polo", "Sailing", "Gaga Ball", "9 Square", "Archery/Tomahawks/Slingshots", "Troop Rifle", "Greased Watermelon", "Reserve Shower House"], "scouts": 17}];
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
        const areas = ['Beach Board', 'Balls', 'Boats', 'Sailing', 'Handicrafts', 'Delta', 'Super Troop',
            'Tower/Climbing', 'Rifle Range', 'Archery', 'Outdoor Skills',
            'Off-Camp', 'Nature Center', 'Campsite', 'Reserves', 'Reflection'];
        const commissioners = ['Commissioner A', 'Commissioner B', 'Commissioner C'];

        // Get current week from URL or use default
        const urlParams = new URLSearchParams(window.location.search);
        const currentWeek = urlParams.get('week') || 'voyageur_week3_troops';

        let currentView = 'troop';

        // Change week by reloading page with new week parameter
        function changeWeek(week) {
            window.location.href = `/?week=${week}`;
        }

        // Create troop tabs
        const troopTabsContainer = document.getElementById('troopTabs');
        let totalScouts = 0, totalAdults = 0;
        troops.forEach(troop => {
            const button = document.createElement('button');
            button.className = 'tab-button';
            button.textContent = troop.name;
            button.onclick = () => loadTroopSchedule(troop.name);
            troopTabsContainer.appendChild(button);
            totalScouts += troop.scouts;
            totalAdults += troop.adults;
        });
        document.getElementById('weekTotal').textContent = `${totalScouts}/${totalAdults}`;

        // Create area tabs
        const areaTabsContainer = document.getElementById('areaTabs');
        areas.forEach(area => {
            const button = document.createElement('button');
            button.className = 'tab-button';
            button.textContent = area;
            button.onclick = () => loadAreaSchedule(area);
            areaTabsContainer.appendChild(button);
        });


        // Create staff tabs
        const staffMembers = [
            'Commissioner A',
            'Commissioner B',
            'Commissioner C',
            'Commissioner D',  // For when other commissioners are busy
            'Beach Staff',
            'Ass. Aquatics',
            'Shooting Sports Director',
            'Archery Director',
            'Tower Director',
            'Outdoor Skills Director',
            'Nature Director',
            'Handicrafts Director'
        ];
        const staffTabsContainer = document.getElementById('staffTabs');
        staffMembers.forEach(staff => {
            const button = document.createElement('button');
            button.className = 'tab-button';
            // Shorten commissioner names
            const displayName = staff.startsWith('Commissioner') ? staff.replace('Commissioner ', 'Comm. ') : staff;
            button.textContent = displayName;
            button.onclick = () => {
                if (staff.startsWith('Commissioner')) {
                    loadCommissionerSchedule(staff);
                } else {
                    loadStaffSchedule(staff);
                }
            };
            staffTabsContainer.appendChild(button);
        });

        // Add All Staff Needs button
        const staffNeedsButton = document.createElement('button');
        staffNeedsButton.className = 'tab-button';
        staffNeedsButton.textContent = 'All Staff Needs';
        staffNeedsButton.onclick = () => loadStaffRequirements();
        staffTabsContainer.appendChild(staffNeedsButton);

        function clearActiveTabs() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        async function loadTroopSchedule(troopName) {
            currentView = 'troop';
            clearActiveTabs();
            event.target.classList.add('active');

            document.getElementById('scheduleTitle').textContent = `Troop: ${troopName}`;
            document.getElementById('scheduleContent').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch(`/api/schedule/${troopName}?week=${currentWeek}`);
                const data = await response.json();
                document.getElementById('scheduleTitle').textContent = `Troop: ${troopName} (${data.scouts}/${data.adults})`;
                renderTroopScheduleGrid(data.schedule);
            } catch (error) {
                document.getElementById('scheduleContent').innerHTML = '<div class="loading">Error loading schedule</div>';
                console.error('Error:', error);
            }
        }

        async function loadAreaSchedule(areaName) {
            currentView = 'area';
            clearActiveTabs();
            event.target.classList.add('active');

            document.getElementById('scheduleTitle').textContent = `Area: ${areaName}`;
            document.getElementById('scheduleContent').innerHTML = '<div class="loading">Loading...</div>';

            try {
                // Special handling for Beach Board
                if (areaName === 'Beach Board') {
                    const response = await fetch(`/api/beach_board?week=${currentWeek}`);
                    const data = await response.json();
                    renderBeachBoard(data);
                } else if (areaName === 'Balls') {
                    const response = await fetch(`/api/balls?week=${currentWeek}`);
                    const data = await response.json();
                    renderBallsBoard(data);
                } else {
                    const response = await fetch(`/api/area/${encodeURIComponent(areaName)}?week=${currentWeek}`);
                    const data = await response.json();
                    renderAreaScheduleGrid(data, areaName);
                }
            } catch (error) {
                document.getElementById('scheduleContent').innerHTML = '<div class="loading">Error loading schedule</div>';
                console.error('Error:', error);
            }
        }

        async function loadCommissionerSchedule(commissionerName) {
            currentView = 'commissioner';
            clearActiveTabs();
            event.target.classList.add('active');

            document.getElementById('scheduleTitle').textContent = `${commissionerName}`;
            document.getElementById('scheduleContent').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch(`/api/commissioner/${encodeURIComponent(commissionerName)}?week=${currentWeek}`);
                const data = await response.json();
                renderCommissionerScheduleGrid(data);
            } catch (error) {
                document.getElementById('scheduleContent').innerHTML = '<div class="loading">Error loading schedule</div>';
                console.error('Error:', error);
            }
        }

        async function loadReflectionSchedule() {
            currentView = 'reflection';
            clearActiveTabs();
            event.target.classList.add('active');

            document.getElementById('scheduleTitle').textContent = 'Friday Reflection Schedule';
            document.getElementById('scheduleContent').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch(`/api/reflection?week=${currentWeek}`);
                const data = await response.json();
                renderReflectionScheduleGrid(data);
            } catch (error) {
                document.getElementById('scheduleContent').innerHTML = '<div class="loading">Error loading schedule</div>';
                console.error('Error:', error);
            }
        }

        async function loadStaffSchedule(staffName) {
            currentView = 'staff';
            clearActiveTabs();
            event.target.classList.add('active');

            document.getElementById('scheduleTitle').textContent = `Staff: ${staffName}`;
            document.getElementById('scheduleContent').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch(`/api/staff/${encodeURIComponent(staffName)}?week=${currentWeek}`);
                const data = await response.json();
                renderStaffScheduleGrid(data, staffName);
            } catch (error) {
                document.getElementById('scheduleContent').innerHTML = '<div class="loading">Error loading schedule</div>';
                console.error('Error:', error);
            }
        }

        function renderTroopScheduleGrid(scheduleData) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Header row
            grid.innerHTML = '<div class="grid-header"></div>';
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="grid-header">${day}</div>`;
            });

            // Slot rows
            for (let slot = 1; slot <= 3; slot++) {
                grid.innerHTML += `<div class="slot-label">Slot ${slot}</div>`;

                days.forEach(day => {
                    // Thursday slot 3 doesn't exist
                    if (day === 'THURSDAY' && slot === 3) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.background = '#1a1a1a';
                        cell.style.color = '#666';
                        cell.innerHTML = '<strong style="font-size: 16px;">✕</strong><br><small>CLOSED</small>';
                        grid.appendChild(cell);
                        return;
                    }

                    const cellData = scheduleData[day][slot];
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';

                    if (cellData) {
                        if (cellData.is_continuation) {
                            cell.classList.add('continuation');
                            if (cellData.slots === 1.5) {
                                cell.innerHTML = `
                                    <span class="continuation-arrow">↳</span>
                                    <div class="activity-name">${cellData.activity}</div>
                                    <div class="activity-duration">(+30 min)</div>
                                `;
                            } else {
                                cell.innerHTML = `
                                    <span class="continuation-arrow">↳</span>
                                    <div class="activity-name">${cellData.activity}</div>
                                `;
                            }
                        } else {
                            cell.classList.add('activity');

                            // Color based on priority ranking
                            // NOTE: priority is 0-indexed (Top 1 = 0, Top 5 = 4, Top 10 = 9)
                            const priority = cellData.priority || 999;
                            const isCommissionerActivity = ['Delta', 'Super Troop', 'Reflection'].includes(cellData.activity);

                            if (priority < 5) {  // 0-4 = Top 1-5
                                cell.classList.add('priority-high');  // Vibrant green
                            } else if (priority < 10) {  // 5-9 = Top 6-10
                                cell.classList.add('priority-medium');  // Less vibrant green
                            } else if (priority < 15) {  // 10-14 = Top 11-15
                                cell.classList.add('priority-moderate');  // Bright yellow
                            } else if (priority < 20) {  // 15-19 = Top 16-20
                                cell.classList.add('priority-moderate-low');  // Darker yellow
                            } else if (isCommissionerActivity) {
                                cell.classList.add('priority-commissioner');  // Blue for commissioners
                            } else {
                                cell.classList.add('priority-low');  // Gray
                            }

                            let duration = '';
                            if (cellData.slots === 1.5) {
                                duration = '(90 min)';
                            } else if (cellData.slots === 2) {
                                duration = '(2 hrs)';
                            } else if (cellData.slots === 3) {
                                duration = '(3 hrs)';
                            }

                            // Add spillover indicator if applicable
                            let spilloverIcon = '';
                            if (cellData.is_spillover) {
                                spilloverIcon = '<span style="color: #ff8800; font-weight: bold;" title="Not on designated commissioner day">⚠️</span> ';
                                cell.style.border = '2px solid #ff8800';
                            }

                            cell.innerHTML = `
                                <div class="activity-name">${spilloverIcon}${cellData.activity}</div>
                                ${duration ? `<div class="activity-duration">${duration}</div>` : ''}
                            `;
                        }
                    } else {
                        cell.textContent = '-';
                    }

                    grid.appendChild(cell);
                });
            }

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        function renderAreaScheduleGrid(scheduleData, areaName) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Header row
            grid.innerHTML = '<div class="grid-header"></div>';
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="grid-header">${day}</div>`;
            });

            // Special handling for Sailing: 2 sessions per day
            if (areaName === 'Sailing' && scheduleData['MONDAY'] && scheduleData['MONDAY']['session1']) {
                const sessions = [
                    { key: 'session1', label: 'Session 1 (Slots 1-2)', color: '#2d5016' },
                    { key: 'session2', label: 'Session 2 (Slots 2-3)', color: '#1d4d0d' }
                ];

                sessions.forEach(session => {
                    // Make session label 1.5x height
                    grid.innerHTML += `<div class="slot-label" style="font-size: 7px; min-height: 60px;">${session.label}</div>`;

                    days.forEach(day => {
                        const sessionData = scheduleData[day][session.key];
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.minHeight = '60px';  // 1.5x normal height (40px * 1.5)

                        if (sessionData && sessionData.troops && sessionData.troops.length > 0) {
                            cell.classList.add('activity');
                            cell.style.background = session.color;
                            cell.innerHTML = `<div class="activity-name">${sessionData.troops.join(', ')}</div>`;
                        } else {
                            cell.textContent = '-';
                        }

                        grid.appendChild(cell);
                    });
                });

                document.getElementById('scheduleContent').innerHTML = '';
                document.getElementById('scheduleContent').appendChild(grid);
                return;
            }

            // Regular area: Slot rows
            for (let slot = 1; slot <= 3; slot++) {
                grid.innerHTML += `<div class="slot-label">Slot ${slot}</div>`;

                days.forEach(day => {
                    // Thursday slot 3 doesn't exist
                    if (day === 'THURSDAY' && slot === 3) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.background = '#1a1a1a';
                        cell.style.color = '#666';
                        cell.innerHTML = '<strong style="font-size: 16px;">✕</strong><br><small>CLOSED</small>';
                        grid.appendChild(cell);
                        return;
                    }

                    const cellData = scheduleData[day][slot];
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';

                    if (cellData && cellData.length > 0) {
                        cell.classList.add('activity');

                        // Group by activity
                        const activityGroups = {};
                        cellData.forEach(item => {
                            if (!activityGroups[item.activity]) {
                                activityGroups[item.activity] = [];
                            }
                            activityGroups[item.activity].push(item);
                        });

                        // Set cell background based on first activity's priority
                        // NOTE: priority is 0-indexed
                        const firstKey = Object.keys(activityGroups)[0];
                        const priority = activityGroups[firstKey][0].priority;
                        const isCommissionerActivity = ['Super Troop', 'Reflection'].includes(firstKey);

                        if (priority < 5) cell.style.background = '#2d5016';  // Top 1-5
                        else if (priority < 10) cell.style.background = '#3d3d16';  // Top 6-10
                        else if (priority < 15) cell.style.background = '#5c5016';  // Top 11-15 (bright yellow)
                        else if (priority < 20) cell.style.background = '#4d4016';  // Top 16-20 (darker yellow)
                        else if (priority >= 999 && isCommissionerActivity) cell.style.background = '#1a4d80';  // Commissioner
                        else cell.style.background = '#3a3a3a';  // Other

                        let html = '';
                        Object.keys(activityGroups).forEach(activity => {
                            const items = activityGroups[activity];
                            const troopList = items.map(item =>
                                `${item.troop} (${item.scouts}/${item.adults})`
                            ).join(', ');

                            html += `<div style="margin-bottom: 3px;">
                                <strong style="font-size: 9px;">${activity}</strong><br>
                                <small style="font-size: 8px;">${troopList}</small>
                            </div>`;
                        });

                        cell.innerHTML = html;
                    } else {
                        cell.textContent = '-';
                    }

                    grid.appendChild(cell);
                });
            }

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        function renderCommissionerScheduleGrid(scheduleData) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Header row
            grid.innerHTML = '<div class="grid-header"></div>';
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="grid-header">${day}</div>`;
            });

            // Slot rows
            for (let slot = 1; slot <= 3; slot++) {
                grid.innerHTML += `<div class="slot-label">Slot ${slot}</div>`;

                days.forEach(day => {
                    const cellData = scheduleData[day][slot];
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';

                    if (cellData && cellData.length > 0) {
                        cell.classList.add('activity');

                        // Separate own troops from borrowed
                        const ownItems = cellData.filter(item => !item.borrowed);
                        const borrowedItems = cellData.filter(item => item.borrowed);

                        // Group by activity
                        const ownActivities = {};
                        ownItems.forEach(item => {
                            if (!ownActivities[item.activity]) {
                                ownActivities[item.activity] = [];
                            }
                            ownActivities[item.activity].push(item.troop);
                        });

                        const borrowedActivities = {};
                        borrowedItems.forEach(item => {
                            if (!borrowedActivities[item.activity]) {
                                borrowedActivities[item.activity] = [];
                            }
                            borrowedActivities[item.activity].push({
                                troop: item.troop,
                                from: item.from_commissioner
                            });
                        });

                        let html = '';

                        // Own troops first (green/normal)
                        Object.keys(ownActivities).forEach(activity => {
                            const troops = ownActivities[activity].join(', ');
                            html += `<div style="margin-bottom: 5px;"><strong>${activity}</strong><br><small>${troops}</small></div>`;
                        });

                        // Borrowed troops in red
                        Object.keys(borrowedActivities).forEach(activity => {
                            const items = borrowedActivities[activity];
                            const troopInfo = items.map(i => `${i.troop}`).join(', ');
                            const fromComm = items[0].from ? items[0].from.replace('Commissioner ', '') : '?';
                            html += `<div style="margin-bottom: 5px; background: #4d1a1a; padding: 3px; border-radius: 3px;">
                                <strong style="color: #ff6b6b;">${activity}</strong><br>
                                <small style="color: #ff9999;">${troopInfo}</small><br>
                                <small style="color: #888; font-size: 6px;">↳ Comm ${fromComm}'s troop</small>
                            </div>`;
                        });

                        cell.innerHTML = html;
                    } else {
                        cell.textContent = '-';
                    }

                    grid.appendChild(cell);
                });
            }

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        function renderBeachBoard(beachData) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';
            // 1 activity column + 3 slots * 5 days = 16 columns
            grid.style.gridTemplateColumns = '120px repeat(15, 1fr)';
            grid.style.fontSize = '0.9em';

            // Header row - Day names spanning 3 slots each
            grid.innerHTML = '<div class="grid-header" style="font-size: 12px; padding: 8px;">Activity</div>';
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="grid-header" style="font-size: 11px; padding: 6px; grid-column: span 3; border-left: 2px solid #555;">${day}</div>`;
            });

            // Sub-header row - Slot numbers
            grid.innerHTML += '<div class="grid-header" style="font-size: 10px; padding: 4px;"></div>';
            dayNames.forEach((day, dayIdx) => {
                for (let slot = 1; slot <= 3; slot++) {
                    const borderStyle = slot === 1 ? 'border-left: 2px solid #555;' : '';
                    grid.innerHTML += `<div class="grid-header" style="font-size: 9px; padding: 4px; ${borderStyle}">S${slot}</div>`;
                }
            });

            // For each beach activity, create rows
            const activities = Object.keys(beachData);
            activities.forEach(activity => {
                // Activity name label
                const activityLabel = document.createElement('div');
                activityLabel.className = 'slot-label';
                activityLabel.style.fontSize = '10px';
                activityLabel.style.fontWeight = 'bold';
                activityLabel.style.padding = '8px';
                activityLabel.textContent = activity;
                grid.appendChild(activityLabel);

                // For each day and slot, show troops scheduled
                days.forEach((day, dayIdx) => {
                    const dayData = beachData[activity][day];
                    for (let slot = 1; slot <= 3; slot++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.minHeight = '45px';
                        cell.style.fontSize = '9px';
                        cell.style.padding = '4px';
                        if (slot === 1) {
                            cell.style.borderLeft = '2px solid #555';
                        }

                        // Thursday slot 3 doesn't exist
                        if (days[dayIdx] === 'THURSDAY' && slot === 3) {
                            cell.style.background = '#1a1a1a';
                            cell.style.color = '#666';
                            cell.innerHTML = '<small>X</small>';
                            grid.appendChild(cell);
                            continue;
                        }

                        const troops = dayData[slot] || [];
                        if (troops.length > 0) {
                            cell.classList.add('activity');
                            cell.style.background = '#2d5016';

                            // Handle Aqua Trampoline objects vs plain troop names
                            let troopNames;
                            if (typeof troops[0] === 'object' && troops[0].troop) {
                                troopNames = troops.map(t => t.troop);
                            } else {
                                troopNames = troops;
                            }

                            cell.innerHTML = `<div style="font-size: 9px; line-height: 1.2;">${troopNames.join('<br>')}</div>`;
                        } else {
                            cell.textContent = '-';
                        }

                        grid.appendChild(cell);
                    }
                });
            });

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        function renderBallsBoard(ballsData) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';
            // 1 activity column + 3 slots * 5 days = 16 columns
            grid.style.gridTemplateColumns = '120px repeat(15, 1fr)';
            grid.style.fontSize = '0.9em';

            // Header row - Day names spanning 3 slots each
            grid.innerHTML = '<div class="grid-header" style="font-size: 12px; padding: 8px;">Activity</div>';
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="grid-header" style="font-size: 11px; padding: 6px; grid-column: span 3; border-left: 2px solid #555;">${day}</div>`;
            });

            // Sub-header row - Slot numbers
            grid.innerHTML += '<div class="grid-header" style="font-size: 10px; padding: 4px;"></div>';
            dayNames.forEach((day, dayIdx) => {
                for (let slot = 1; slot <= 3; slot++) {
                    const borderStyle = slot === 1 ? 'border-left: 2px solid #555;' : '';
                    grid.innerHTML += `<div class="grid-header" style="font-size: 9px; padding: 4px; ${borderStyle}">S${slot}</div>`;
                }
            });

            // For each balls activity, create rows
            const activities = Object.keys(ballsData);
            activities.forEach(activity => {
                // Activity name label
                const activityLabel = document.createElement('div');
                activityLabel.className = 'slot-label';
                activityLabel.style.fontSize = '10px';
                activityLabel.style.fontWeight = 'bold';
                activityLabel.style.padding = '8px';
                activityLabel.textContent = activity;
                grid.appendChild(activityLabel);

                // For each day and slot, show troops scheduled
                days.forEach((day, dayIdx) => {
                    const dayData = ballsData[activity][day];
                    for (let slot = 1; slot <= 3; slot++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.minHeight = '45px';
                        cell.style.fontSize = '9px';
                        cell.style.padding = '4px';
                        if (slot === 1) {
                            cell.style.borderLeft = '2px solid #555';
                        }

                        const troops = dayData[slot] || [];
                        if (troops.length > 0) {
                            cell.classList.add('activity');
                            cell.style.background = '#3d5016';
                            cell.innerHTML = `<div style="font-size: 9px; line-height: 1.2;">${troops.join('<br>')}</div>`;
                        } else {
                            cell.textContent = '-';
                        }

                        grid.appendChild(cell);
                    }
                });
            });

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        function renderReflectionScheduleGrid(scheduleData) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';
            grid.style.gridTemplateColumns = '100px repeat(3, 1fr)';

            // Header row
            grid.innerHTML = '<div class="grid-header"></div>';
            ['Slot 1', 'Slot 2', 'Slot 3'].forEach(slot => {
                grid.innerHTML += `<div class="grid-header">${slot}</div>`;
            });

            // Commissioner rows
            commissioners.forEach(commissioner => {
                const cell = document.createElement('div');
                cell.className = 'slot-label';
                cell.textContent = commissioner;
                grid.appendChild(cell);

                for (let slot = 1; slot <= 3; slot++) {
                    const cellData = scheduleData[slot][commissioner];
                    const dataCell = document.createElement('div');
                    dataCell.className = 'grid-cell';

                    if (cellData) {
                        // Check if commissioner is available
                        if (!cellData.available) {
                            // Commissioner has conflict
                            dataCell.style.background = '#4d1a1a';  // Dark red
                            dataCell.innerHTML = `
                                <div style="color: #ff6b6b; font-weight: bold; margin-bottom: 4px;">
                                    ⚠️ UNAVAILABLE
                                </div>
                                <div style="font-size: 7px; color: #aaa;">
                                    ${cellData.conflict || 'Conflict'}
                                </div>
                            `;
                        } else if (cellData.troops && cellData.troops.length > 0) {
                            // Commissioner is available and has troops
                            dataCell.classList.add('activity');
                            dataCell.innerHTML = `<div class="activity-name">${cellData.troops.join(', ')}</div>`;
                        } else {
                            // Commissioner is available but no troops assigned
                            dataCell.style.background = '#2d3d2d';  // Slightly green tint
                            dataCell.innerHTML = `<div style="color: #6b6; font-size: 7px;">✓ Available</div>`;
                        }
                    } else {
                        dataCell.textContent = '-';
                    }

                    grid.appendChild(dataCell);
                }
            });

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        function renderStaffScheduleGrid(scheduleData, staffName) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Header row
            grid.innerHTML = '<div class="grid-header"></div>';
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="grid-header">${day}</div>`;
            });

            // Slot rows
            for (let slot = 1; slot <= 3; slot++) {
                grid.innerHTML += `<div class="slot-label">Slot ${slot}</div>`;

                days.forEach(day => {
                    // Thursday slot 3 doesn't exist
                    if (day === 'THURSDAY' && slot === 3) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.background = '#1a1a1a';
                        cell.style.color = '#666';
                        cell.innerHTML = '<strong style="font-size: 16px;">✕</strong><br><small>CLOSED</small>';
                        grid.appendChild(cell);
                        return;
                    }

                    const cellData = scheduleData[day][slot];
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';

                    if (cellData && cellData.length > 0) {
                        cell.classList.add('activity');

                        // Group by activity
                        const activityGroups = {};
                        cellData.forEach(item => {
                            if (!activityGroups[item.activity]) {
                                activityGroups[item.activity] = [];
                            }
                            activityGroups[item.activity].push(item);
                        });

                        // Set cell background based on first activity's priority
                        // Use blue tones for staffed schedules to distinguish from area boards
                        const firstKey = Object.keys(activityGroups)[0];
                        const priority = activityGroups[firstKey][0].priority;
                        const isCommissionerActivity = ['Super Troop', 'Reflection'].includes(firstKey);

                        if (priority < 5) cell.style.background = '#1a4d6b';  // Dark blue for Top 1-5
                        else if (priority < 10) cell.style.background = '#2a3d4d';  // Blue-gray for Top 6-10
                        else if (priority >= 999 && isCommissionerActivity) cell.style.background = '#1a4d80';  // Commissioner blue
                        else cell.style.background = '#3a3a3a';  // Gray for other

                        let html = '';
                        Object.keys(activityGroups).forEach(activity => {
                            const items = activityGroups[activity];
                            const troops = items.map(item =>
                                `${item.troop} (${item.scouts}/${item.adults})`
                            ).join(', ');

                            html += `<div style="margin-bottom: 3px;">
                                <strong style="font-size: 9px;">${activity}</strong><br>
                                <small style="font-size: 8px;">${troops}</small>
                            </div>`;
                        });

                        cell.innerHTML = html;
                    } else {
                        cell.textContent = '-';
                    }

                    grid.appendChild(cell);
                });
            }

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        async function loadStaffRequirements() {
            document.getElementById('scheduleTitle').textContent = 'All Staff Requirements';
            document.getElementById('scheduleContent').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch(`/api/staff-requirements?week=${currentWeek}`);
                const data = await response.json();
                renderStaffRequirements(data);
            } catch (error) {
                document.getElementById('scheduleContent').innerHTML = '<div class="error">Error loading staff requirements</div>';
            }
        }

        function renderStaffRequirements(data) {
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Header row
            grid.innerHTML = '<div class="grid-header"></div>';
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="grid-header">${day}</div>`;
            });

            // Slot rows
            for (let slot = 1; slot <= 3; slot++) {
                grid.innerHTML += `<div class="slot-label">Slot ${slot}</div>`;

                days.forEach(day => {
                    // Thursday slot 3 doesn't exist
                    if (day === 'THURSDAY' && slot === 3) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.style.background = '#1a1a1a';
                        cell.style.color = '#666';
                        cell.innerHTML = '<strong style="font-size: 16px;">X</strong><br><small>CLOSED</small>';
                        grid.appendChild(cell);
                        return;
                    }

                    const slotData = data[day][slot];
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.classList.add('activity');

                    const count = slotData.total_staff;
                    const recommended = slotData.recommended_staff || 0;

                    // Color spectrum for 15 staff max (5+ starts green, 14-15 is red)
                    // Use recommended count if higher than actual for coloring
                    const displayCount = Math.max(count, recommended);

                    if (displayCount === 0) {
                        cell.style.background = '#1a1a1a';  // Dark (no staff)
                    } else if (displayCount <= 4) {
                        cell.style.background = '#2a2a2a';  // Dark gray (very light)
                    } else if (displayCount <= 7) {
                        cell.style.background = '#2d5016';  // Green (light load)
                    } else if (displayCount <= 10) {
                        cell.style.background = '#4a5c16';  // Yellow-green (moderate)
                    } else if (displayCount <= 13) {
                        cell.style.background = '#5c4a16';  // Yellow/orange (getting busy)
                    } else {
                        cell.style.background = '#5d2016';  // Red (14-15, at/over capacity)
                    }

                    // Display format: "12 staff" or "12 staff (+3)" if extra needed
                    let staffText = `${count} staff`;
                    if (recommended > 0) {
                        staffText += ` <span style="color: #ff8800;">(+${recommended})</span>`;
                    }

                    let html = `<div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${staffText}</div>`;

                    // Show breakdown by director
                    const directors = Object.entries(slotData.by_director).sort((a, b) => b[1] - a[1]);
                    directors.forEach(([director, dirCount]) => {
                        html += `<div style="font-size: 8px; margin-bottom: 1px;">
                            ${director}: ${dirCount}
                        </div>`;
                    });

                    cell.innerHTML = html;
                    grid.appendChild(cell);
                });
            }

            document.getElementById('scheduleContent').innerHTML = '';
            document.getElementById('scheduleContent').appendChild(grid);
        }

        // Load first troop by default
        if (troops.length > 0) {
            loadTroopSchedule(troops[0].name);
        }
    </script>
</body>

</html>
